# Patient Tracker â€” Firebase Auth & User Flow Documentation
(Last updated: after Firestore integration + ensureUserDoc fixes)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ feature/auth/ui/signup/SignUpViewModel.kt
Role: Handles user registration via Email/Password or Google.
Purpose: Manages sign-up form state and triggers user creation both in Firebase Auth and Firestore.
Usage: Invoked by SignUpScreen; interacts with AuthRepository and UserRepository.
Key logic:
  â€¢ registerWithEmailAndPassword(): Registers user and calls userRepository.ensure() to create Firestore user doc.
  â€¢ registerWithGoogle(): Signs in with Google and ensures user doc exists.
  â€¢ updateName(), updateEmail(), updatePassword(): Validate and update UI text fields.
Fixes/Notes:
  â€¢ Added proper logging with TAG = "Auth/SignUpVM".
  â€¢ Ensures Firestore write completion by awaiting ensureUserDoc().
  â€¢ Falls back to typed name if displayName is empty.
  â€¢ Runs inside viewModelScope; exceptions logged safely.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ feature/auth/ui/signin/SignInViewModel.kt
Role: Handles sign-in with email, Google, or saved credentials.
Purpose: Authenticates existing users and ensures Firestore documents exist.
Usage: Called from SignInScreen and integrated into Auth flow.
Key logic:
  â€¢ loginWithEmailAndPassword(): Signs in, then calls userRepository.ensure() (on a NonCancellable background job).
  â€¢ signInWithGoogle(): Same ensure pattern; backfills user docs for Google users.
  â€¢ signInWithSavedCredentials(): Handles auto sign-in from Smart Lock / Credential Manager; ensures Firestore doc.
Fixes/Notes:
  â€¢ Previously ensureUserDoc() was never calledâ€”now fully integrated.
  â€¢ Fixed coroutine JobCancellationException by isolating writes in a new IO coroutine.
  â€¢ Added detailed Logcat tracing for enter/exit and Firestore ensure() events.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ data/repository/profile/UserRepository.kt
Role: Domain-layer bridge between app logic and Firestore user documents.
Purpose: Ensures users exist in Firestore and manages their roles.
Usage: Injected into Auth and Profile ViewModels.
Key methods:
  â€¢ ensure(uid, email, name): Ensures user doc exists, logs success/failure.
  â€¢ get(uid): Retrieves existing user doc.
  â€¢ setRole(uid, role): Updates userâ€™s role field in Firestore.
Fixes/Notes:
  â€¢ Added rich debug logging (FirestoreDebug tag).
  â€¢ Catches and logs all exceptions; rethrows for higher-level handling.
  â€¢ Used toDomain() to convert FirebaseAppUser â†’ AppUser cleanly.
  â€¢ ensure() now confirmed working after Firestore rule correction and async fix.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ firebase/firestore/data/UserDataSource.kt
Role: Low-level Firestore access layer for /users collection.
Purpose: Creates and reads user documents; updates role fields.
Usage: Used by UserRepository.
Key methods:
  â€¢ ensureUserDoc(uid, email, displayName)
  â€¢ getUser(uid)
  â€¢ setRole(uid, role)
Notes:
  â€¢ Runs all Firestore ops on IO dispatcher.
  â€¢ Throws explicit FirebaseFirestoreException on permission or network issues.
  â€¢ Now compatible with new Firestore security rules allowing self-writes.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ firebase/firestore/data/DoctorRequestDataSource.kt
Role: Firestore layer for /doctor_requests.
Purpose: Handles doctor verification requests submitted by patients or admins.
Usage: Used by DoctorRequestRepository.
Key methods:
  â€¢ create() â€” creates new request document.
  â€¢ observePending() â€” snapshot listener for live updates.
  â€¢ setStatus() â€” updates approval/rejection.
Notes:
  â€¢ Uses real-time snapshot listeners via addSnapshotListener().
  â€¢ Observed by admin and doctor dashboards for live state.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ data/repository/profile/DoctorRequestRepository.kt
Role: Domain-level API for doctor verification and access requests.
Purpose: Abstracts Firestore operations behind high-level app logic.
Usage: Used by Admin and Doctor ViewModels.
Key methods:
  â€¢ create(), approve(), reject(), observePending().
Notes:
  â€¢ Converts FirebaseDoctorRequest â†’ DoctorRequest domain model.
  â€¢ Emits Flow for reactive UI updates.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ data/model/profile/AppUser.kt
Role: Domain model representing a userâ€™s Firestore document.
Purpose: Clean model for UI and ViewModels.
Fields: uid, email, displayName, role, approved (bool)
Notes:
  â€¢ approved = approvedAt != null (auto true for approved doctors).
  â€¢ Serves as standard user representation across the app.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ data/model/profile/DoctorRequest.kt
Role: Domain model for doctor credential verification.
Purpose: Encapsulates all fields related to pending doctor requests.
Fields: id, uid, fullName, specialization, licenseNumber, status (PENDING/APPROVED/REJECTED)
Notes:
  â€¢ Mirrors FirebaseDoctorRequest Firestore model.
  â€¢ Used by both DoctorRequestRepository and admin UI.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ firebase/firestore/rules/firestore.rules
Role: Defines Firestore access policy for all data.
Purpose: Protects user and patient records while enabling role-based access.
Key rules:
  â€¢ /users/{uid} â€” user can read/write their own doc.
  â€¢ /doctor_requests/{id} â€” patient can create, admin can approve/reject.
  â€¢ /records, /appointments â€” (future) restricted to owner/assigned doctor.
Fixes/Notes:
  â€¢ Old rule `allow read, write: if false;` blocked all writes â€” fixed.
  â€¢ Current rules enforce authenticated self-writes and admin-only management.
  â€¢ To be extended for full doctorâ€“patient logic.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”¹ overall next steps
1. Add fields: role, createdAt, updatedAt, approvedAt to ensure() write.
2. Add AccessGrantDataSource & Repository for doctorâ€“patient linking.
3. Add PatientRecordDataSource & Repository for record storage.
4. Implement minimal admin panel for approving doctor accounts.
5. Integrate role-based navigation in the app (Admin â†’ approvals, Doctor â†’ patients, Patient â†’ records).
6. Add Firestore indexes for grants/appointments.
7. Test rules via Firebase Emulator Suite.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Summary:
âœ” Auth + Firestore persistence working for both sign-up and sign-in.
âœ” Firestore rules fixed and confirmed operational.
âš™ Doctorâ€“patient logic skeleton in place (needs AccessGrant + Records).
âš™ Admin logic pending for doctor approvals.
Next milestone: full role-based dashboard flows (Admin/Doctor/Patient).
