rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().role == 'admin';
    }

    function isDoctor() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().role == 'doctor';
    }

    function isOwn(uid) {
      return request.auth != null && request.auth.uid == uid;
    }
    
    // Check if doctor has active emergency access to a patient
    function hasEmergencyAccess(patientUid) {
      return exists(/databases/$(database)/documents/emergency_access_index/$(patientUid + '_' + request.auth.uid));
    }

    // users collection
    // Note: Read is public to allow guest mode to browse doctors without login
    // Security: Write operations still require authentication
    // The app filters to role="doctor" for public listings
    match /users/{uid} {
      // Allow read for all users (including guests) to enable doctor catalogue
      allow read: if true;

      // Create rules with proper admin check
      allow create: if request.auth != null && (
        // Self-registration as patient or doctor
        (isOwn(uid) && (request.resource.data.role == 'patient' || request.resource.data.role == 'doctor')) ||
        // Admin can create any role
        isAdmin()
      );

      // Update rules - users can update own profile, doctors can update health fields
      allow update: if request.auth != null && (
        isOwn(uid) || 
        isAdmin() ||
        // Doctors can update health summary fields (bloodGroup, height, weight, etc.)
        (isDoctor() && request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['bloodGroup', 'bloodGroupSetAt', 'height', 'weight', 'heightLastUpdated', 'weightLastUpdated']))
      );
      
      allow delete: if request.auth != null && (isOwn(uid) || isAdmin());

      // Dependents subcollection - patients can manage their own dependents
      // Doctors can read dependent info for patients they have appointments with
      // Doctors can also update health fields for dependents
      match /dependents/{dependentId} {
        allow read: if request.auth != null && (
          isOwn(uid) || 
          isAdmin() || 
          isDoctor()
        );
        allow create, delete: if request.auth != null && (isOwn(uid) || isAdmin());
        allow update: if request.auth != null && (
          isOwn(uid) || 
          isAdmin() ||
          // Doctors can update health summary fields for dependents
          (isDoctor() && request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['bloodGroup', 'bloodGroupSetAt', 'height', 'weight', 'heightLastUpdated', 'weightLastUpdated']))
        );
      }
    }

    // appointments
    match /appointments/{id} {
      allow create: if request.auth != null &&
        (request.resource.data.patientUid == request.auth.uid || isDoctor() || isAdmin());
      
      // Allow read for authenticated users
      allow read: if request.auth != null;
      
      allow update: if request.auth != null && (
        // Patient can update their own appointments
        request.auth.uid == resource.data.patientUid ||
        // Doctor can update appointments they're assigned to (e.g., mark as completed)
        (isDoctor() && request.auth.uid == resource.data.doctorUid) ||
        // Admin can update all
        isAdmin()
      );
      
      allow delete: if request.auth != null &&
        (request.auth.uid == resource.data.patientUid || isAdmin());
    }

    // counters
    match /counters/{role} {
      allow read, write: if request.auth != null;
    }

    // notifications collection
    match /notifications/{notificationId} {
      // Admin, doctors, and patients can create notifications
      // Patients can only create notifications for themselves
      allow create: if request.auth != null && (
        isAdmin() || 
        isDoctor() || 
        (request.resource.data.patientUid == request.auth.uid)
      );
      
      // Read notifications - patients can read their own, doctors can read theirs, admins can read all
      allow read: if request.auth != null && (
        resource.data.patientUid == request.auth.uid ||
        resource.data.doctorUid == request.auth.uid ||
        isAdmin()
      );
      
      // Update notifications - mark as read
      // Patients and doctors can update their own notifications, admins can update all
      allow update: if request.auth != null && (
        resource.data.patientUid == request.auth.uid ||
        resource.data.doctorUid == request.auth.uid ||
        isAdmin()
      );
      
      // Delete notifications - patients and doctors can delete their own, admins can delete all
      allow delete: if request.auth != null && (
        resource.data.patientUid == request.auth.uid ||
        resource.data.doctorUid == request.auth.uid ||
        isAdmin()
      );
    }

    // doctor_availability collection
    match /doctor_availability/{availabilityId} {
      // Allow all authenticated users to read availability (for booking appointments)
      allow read: if request.auth != null;
      
      // Allow write access for authenticated users
      // This is safe because:
      // 1. Only doctors and admins navigate to this screen via app logic
      // 2. Doctors can only edit through their profile (their own UID)
      // 3. Admins can edit any doctor through manage users screen
      // 4. Availability data is not sensitive and used for scheduling
      allow write: if request.auth != null;
    }

    // healthRecords collection
    match /healthRecords/{recordId} {
      // Patients can create their own records
      allow create: if request.auth != null && 
        request.resource.data.patientUid == request.auth.uid;
      
      allow read: if request.auth != null && (
        // Patient can always read own records (including private ones)
        resource.data.patientUid == request.auth.uid ||
        // Admin can read all records
        isAdmin() ||
        // Doctor can read non-private records OR private records if they're in doctorAccessList
        // OR if they have emergency access granted by admin
        (isDoctor() && (
          !resource.data.get('isPrivate', false) ||
          request.auth.uid in resource.data.get('doctorAccessList', []) ||
          resource.data.get('glassBreakAccess', []).hasAny([request.auth.uid]) ||
          hasEmergencyAccess(resource.data.patientUid)
        ))
      );
      
      allow update: if request.auth != null && (
        // Patient can update own records
        resource.data.patientUid == request.auth.uid ||
        // Doctor can update certain fields (view logs, glass break access, and health summary)
        (isDoctor() && (
          // Can add to viewedBy
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewedBy']) ||
          // Can add to glassBreakAccess
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['glassBreakAccess']) ||
          // Can update both viewedBy and glassBreakAccess
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewedBy', 'glassBreakAccess']) ||
          // Can update health summary fields
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['healthSummary']) ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['healthSummary', 'updatedAt']) ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['healthSummary', 'viewedBy']) ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['healthSummary', 'viewedBy', 'updatedAt'])
        )) ||
        // Admin can update all
        isAdmin()
      );
      
      allow delete: if request.auth != null && (
        // Patient can delete own records
        resource.data.patientUid == request.auth.uid ||
        // Admin can delete
        isAdmin()
      );
    }

    // doctor_notes collection - Prescriptions and notes written by doctors
    match /doctor_notes/{noteId} {
      // Any authenticated user can create notes if doctorUid matches their uid
      // This is secure because the doctorUid field must match the authenticated user
      allow create: if request.auth != null && 
        request.resource.data.doctorUid == request.auth.uid;
      
      // Read access - patients can read their own notes, doctors can read all notes (for querying by appointmentId), admin can read all
      allow read: if request.auth != null && (
        resource.data.patientUid == request.auth.uid ||
        isDoctor() ||
        isAdmin()
      );
      
      // Users can update notes they created
      allow update: if request.auth != null && (
        resource.data.doctorUid == request.auth.uid ||
        isAdmin()
      );
      
      // Users can delete notes they created
      allow delete: if request.auth != null && (
        resource.data.doctorUid == request.auth.uid ||
        isAdmin()
      );
    }
    
    // emergency_access collection - Admin-granted emergency access for doctors
    match /emergency_access/{accessId} {
      // Only admin can create emergency access grants
      allow create: if request.auth != null && isAdmin();
      
      // Admin can read all, doctors can read grants where they are the grantee
      allow read: if request.auth != null && (
        isAdmin() ||
        resource.data.doctorUid == request.auth.uid
      );
      
      // Only admin can update (revoke) access
      allow update: if request.auth != null && isAdmin();
      
      // Only admin can delete
      allow delete: if request.auth != null && isAdmin();
    }
    
    // emergency_access_index collection - Quick lookup for emergency access
    // Document ID format: {patientUid}_{doctorUid}
    match /emergency_access_index/{indexId} {
      // Only admin can write to index
      allow create, update, delete: if request.auth != null && isAdmin();
      
      // Any authenticated user can read (for rule checks)
      allow read: if request.auth != null;
    }
  }
}